---
- name: install some dependencies of the cloudstack modules
  pip:
    name: "{{ item }}"
  with_items:
  - cs
  - sshpubkeys

- name: wait for docker image has started
  wait_for:
    port: "{{ cs_prepare_api_port }}"

- name: download API keys
  local_action:
    module: uri
    url: "{{ cs_prepare_api_endpoint }}:{{ cs_prepare_api_port }}/admin.json"
    return_content: yes
  register: api_keys
  until: api_keys.status|int == 200
  retries: 200
  delay: 6
  ignore_errors: yes

- name: create cloudstack.ini of API keys as vars
  local_action:
    module: template
    src: cloudstack.ini.j2
    dest: ./cloudstack.ini
